# 關聯客戶

找出有所關聯的被保人。方法有以下三種:
1. 直接連接: 彼此互為要保人v.s.被保人的關係。
2. 透過要保人連接: 彼此之間沒有直接連接，但擁有相同的要保人。
3. 透過標的物連接: 彼此之間沒有直接連接，但擁有相同的標的物。

## 筆記:
1. 有要保人從來沒有以被保人身分買過保單的; e.g. 5931a0575347fd7c392fc2dac8df3ac1e33ad03b

## 目前考慮:

1. 被保人
2. 要保人
3. 標的物

## 使用資料:

* 時間:
	2017/01/01 ~ 2022/03/31

* 險別:
	1. 車險(包含強制、任意)
	2. Hth(**不包含團傷**) 
	> note: 因主要目標是看關係，因此**包括防疫險**(同時為求一致，計算損率時也陪有排除防疫險)

## 關係:

1. 直接相連: 關係 = 要保人 v.s. 被保人
2. 透過要保人: 關係 = 被保人 v.s. 被保人 (兩者之間至少有一個相同要保人)
3. 透過標的物: 關係 = 被保人 v.s. 被保人 (兩者之間至少有一個相同標的物)

** 以上關係皆不分年 **
> 舉例來說: 結果中小明有10個(直接連接)關聯被保人，表示2017/01/01 ~ 2022/03/31中，他曾與10為被保人互為要保人-被保人


**圖例: 投影 (i.e. 透過某種關係間接相連)**

![alt network_intro](./img/說明/投影圖說明.drawio.png)


**圖例: 投影範例2**

![alt network_intro](./img/說明/投影圖說明2.drawio.png)


---

## 結果:

詳細資料請見: 

- CSV格式: \\tp-fs2\數位發展中心\資料分享區\TmpData\關聯客戶\關聯客戶_prepared.csv
- parquet格式: \\tp-fs2\數位發展中心\資料分享區\TmpData\關聯客戶\關聯客戶_prepared.parq


### 直接連接Tops

請見num_original，此欄表示直接相連的客戶數

- 單純關聯數由高到低 top 10


| index                                    |           plyAmt |           clmAmt |   ipolicy |   clmed_iply |   num_original |   num_byAppl |   num_byTag |   clm_rate |   clm_ratio |   plyAmt_直接連接 |   clmAmt_直接連接 |   ipolicy_直接連接 |   clmed_iply_直接連接 |   clm_rate_直接連接 |   clm_ratio_直接連接 |   plyAmt_通過標的物 |   clmAmt_通過標的物 |   ipolicy_通過標的物 |   clmed_iply_通過標的物 |   clm_rate_通過標的物 |   clm_ratio_通過標的物 |   plyAmt_通過要保 |   clmAmt_通過要保 |   ipolicy_通過要保 |   clmed_iply_通過要保 |   clm_rate_通過要保 |   clm_ratio_通過要保 |                                                                              
|:-----------------------------------------|-----------------:|-----------------:|----------:|-------------:|---------------:|-------------:|------------:|-----------:|------------:|------------------:|------------------:|-------------------:|----------------------:|--------------------:|---------------------:|--------------------:|--------------------:|---------------------:|------------------------:|----------------------:|-----------------------:|------------------:|------------------:|-------------------:|----------------------:|--------------------:|---------------------:|
| f38772d2ef20f8b414f656ea605bb640f400e45a |  14212           |      0           |       116 |            0 |           1150 |         1609 |           1 |   0        |   0         |       7.69403e+06 |       2.88564e+06 |              16215 |                    95 |            0.375049 |           0.00585877 |                   0 |                   0 |                    0 |                       0 |                   nan |                    nan |       1.21848e+07 |       7.37385e+06 |              18364 |                   143 |            0.60517  |           0.00778697 |
| 177e4401aa40fea73e52fb1e5640565a058816bb |   4794           |      0           |       102 |            0 |            732 |          804 |           1 |   0        |   0         |       4.55846e+06 |       1.33986e+06 |               1877 |                    56 |            0.293929 |           0.0298348  |                   0 |                   0 |                    0 |                       0 |                   nan |                    nan |       5.23337e+06 |       2.83131e+06 |               2177 |                    79 |            0.541011 |           0.0362885  |
| 839c5f0f86569b38b03e7937fc7fb1e3d184dda7 |   7380           |      0           |        60 |            0 |            717 |         1511 |           1 |   0        |   0         |       5.73445e+06 |  697823           |              14843 |                    30 |            0.12169  |           0.00202115 |                   0 |                   0 |                    0 |                       0 |                   nan |                    nan |       1.07332e+07 |       3.52882e+06 |              17800 |                   117 |            0.328775 |           0.00657303 |
| 72ab22475edcb0993d864ad16c7e6f072af77cfd |      1.05994e+06 |      4.34288e+06 |       215 |           15 |            654 |          683 |           1 |   4.09731  |   0.0697674 |       9.19632e+06 |       6.65887e+06 |               5094 |                    88 |            0.72408  |           0.0172752  |                   0 |                   0 |                    0 |                       0 |                   nan |                    nan |       9.62653e+06 |       6.65887e+06 |               5457 |                    88 |            0.691721 |           0.0161261  |
| ec226f51d671c12b4217658059c2e2e4ff09a84a |  42369           |  33000           |        39 |            3 |            439 |          461 |           2 |   0.778871 |   0.0769231 |       1.49862e+06 |  247492           |               1270 |                    18 |            0.165147 |           0.0141732  |              223115 |                   0 |                   20 |                       0 |                     0 |                      0 |       1.64889e+06 |  255192           |               1408 |                    23 |            0.154766 |           0.0163352  |
| 6261ce1fcd25c18ba3c6c0fb91991385e635ebcd | 531995           | 234610           |       400 |            5 |            414 |          507 |           2 |   0.441    |   0.0125    |       6.35487e+06 |       3.20405e+06 |              17594 |                    95 |            0.504188 |           0.00539957 |                1555 |                   0 |                    1 |                       0 |                     0 |                      0 |       8.85134e+06 |       3.90832e+06 |              18597 |                   128 |            0.441551 |           0.00688283 |
| 9c0e060cd3e2afb08d1dbab7d25fc252ba1b3023 | 115705           |      0           |       130 |            0 |            382 |         1479 |           1 |   0        |   0         |       4.91369e+06 |       4.89391e+06 |               3174 |                    71 |            0.995974 |           0.0223693  |                   0 |                   0 |                    0 |                       0 |                   nan |                    nan |       2.37778e+08 |       1.50946e+08 |              93427 |                  3031 |            0.634821 |           0.0324424  |
| de72b8c2264945edd12e4d0484757a9570ee8b0b |    244           |      0           |         2 |            0 |            380 |          800 |           1 |   0        |   0         |       2.73087e+06 |       1.38478e+06 |              10807 |                    24 |            0.507084 |           0.00222078 |                   0 |                   0 |                    0 |                       0 |                   nan |                    nan |       5.34016e+06 |       1.74616e+06 |              14271 |                    47 |            0.326987 |           0.00329339 |
| fb1c85ead831d8e2da3a0a1f3e6cd0a81c36d1df |   3360           |      0           |        88 |            0 |            379 |          408 |           1 |   0        |   0         |       4.49338e+06 |       1.57663e+06 |               4489 |                    64 |            0.350879 |           0.0142571  |                   0 |                   0 |                    0 |                       0 |                   nan |                    nan |       4.6269e+06  |       1.65363e+06 |               4660 |                    69 |            0.357395 |           0.0148069  |
| 9479835b33d0c6e9b21b58e91fa428c075096704 |    234           |      0           |         6 |            0 |            356 |          428 |           1 |   0        |   0         |       1.75763e+06 |  671157           |               1463 |                    23 |            0.381854 |           0.0157211  |                   0 |                   0 |                    0 |                       0 |                   nan |                    nan |       2.15337e+06 |  671157           |               1722 |                    23 |            0.311677 |           0.0133566  |

- 高風險族群: clm_ipolicy_直接連接 > .5 & clm_rate_直接連接 > 1
> clm_ipolicy_直接連接 = 與此客戶關聯的所有客戶的 出險保單數 / 保單數
> clm_rate_直接連接 = 與此客戶關聯的所有客戶的 賠付 / 保費


| index                                    |   num_original |   num_byAppl |   num_byTag |   clm_rate |   clm_ratio |   clm_rate_直接連接 |   clm_ratio_直接連接 |   clm_rate_通過標的物 |   clm_ratio_通過標的物 |   clm_rate_通過要保 |   clm_ratio_通過要保 |
|:-----------------------------------------|---------------:|-------------:|------------:|-----------:|------------:|--------------------:|---------------------:|----------------------:|-----------------------:|--------------------:|---------------------:|
| 03a76164866eb37e567dbee841f1075962f28d54 |              7 |            7 |           1 |  15.6413   |         1   |            22.9108  |             1        |                   nan |                    nan |            22.9108  |             1        |
| 56f902b0622f910c496057424ca5cde6b0862145 |              7 |            7 |           1 |   7.69231  |         1   |             7.34574 |             0.818182 |                   nan |                    nan |             7.34574 |             0.818182 |
| fab9cabbbf2560bce04b098b44a1b299e7d550e7 |              7 |            7 |           1 |   5.90948  |         0.5 |            11.619   |             0.6      |                   nan |                    nan |            11.619   |             0.6      |
| f19f54d181f42b660831285ea4bd83a49db01b2a |              7 |            7 |           1 |   1.1617   |         1   |             1.1617  |             1        |                   nan |                    nan |             1.1617  |             1        |
| 2f51e9cf753349f4f037bff0011490c10b30a499 |              6 |            6 |           1 |  18.6548   |         1   |             6.36705 |             0.538462 |                   nan |                    nan |             6.36705 |             0.538462 |
| 4e74338f78fc1b0fe0c13da35e297a12647087e3 |              6 |            6 |           1 |   0.358566 |         0.5 |             2.44068 |             1        |                   nan |                    nan |             2.44068 |             1        |
| 7bc13a8f32fe8cb304c83fdf96b2fa91ab12eeba |              6 |            6 |           1 |   0        |         0   |             6.29588 |             1        |                   nan |                    nan |             6.29588 |             1        |
| 41acd7abd7587407bb96287eb244dfd7998d72a2 |              5 |            5 |           1 |  22.7906   |         1   |            16.6795  |             0.7      |                   nan |                    nan |            16.6795  |             0.7      |
| baf9f7255288f0f6ee87db1c02660bef96bdf0a1 |              5 |            5 |           1 |  10.0901   |         1   |             8.04563 |             1        |                   nan |                    nan |             8.04563 |             1        |
| 90f0b15c41790fcb556b321a881f5e8796de13b4 |              5 |            5 |           1 |   6.68151  |         1   |             4.81928 |             1        |                   nan |                    nan |             4.81928 |             1        |

- 高風險族群: clm_ipolicy_通過要保 > .5 & clm_rate_通過要保 > 1

| index                                    |   num_original |   num_byAppl |   num_byTag |   clm_rate |   clm_ratio |   clm_rate_直接連接 |   clm_ratio_直接連接 |   clm_rate_通過標的物 |   clm_ratio_通過標的物 |   clm_rate_通過要保 |   clm_ratio_通過要保 |
|:-----------------------------------------|---------------:|-------------:|------------:|-----------:|------------:|--------------------:|---------------------:|----------------------:|-----------------------:|--------------------:|---------------------:|
| 1a26ad9c350b240f319b96ae49ab509263c1ded0 |              1 |           19 |           1 |  27.8469   |    1        |           nan       |                  nan |                   nan |                    nan |            26.593   |             0.888889 |
| 69ccd6c9940a74de21ca0f23d451d54a7c8aeb01 |              1 |           19 |           1 |  27.8469   |    1        |           nan       |                  nan |                   nan |                    nan |            26.593   |             0.888889 |
| 9bc4bc95ac51efccb65372d914cf726c19518e13 |              1 |           19 |           1 |  27.8469   |    1        |           nan       |                  nan |                   nan |                    nan |            26.593   |             0.888889 |
| b9b693929a2df682028be46dd2538cb24be1cec3 |              1 |           19 |           1 |  27.8469   |    1        |           nan       |                  nan |                   nan |                    nan |            26.593   |             0.888889 |
| be2b01cf557df1c863d45d6e28b948f8b97744d2 |              1 |           19 |           1 |  27.8469   |    1        |           nan       |                  nan |                   nan |                    nan |            26.593   |             0.888889 |
| d052888df3c33c565eaf3291935b3a122cc42d52 |              1 |           19 |           1 |  27.8469   |    1        |           nan       |                  nan |                   nan |                    nan |            26.593   |             0.888889 |
| fb80acfe1608e0bc9d64c0e7d1e2a7bb8d6b3dd0 |              1 |           19 |           1 |  27.8469   |    1        |           nan       |                  nan |                   nan |                    nan |            26.593   |             0.888889 |
| 765015a67b9984538ab4c63ccfb0bfef9fe45d5c |              2 |           10 |           1 |   0.180852 |    0.166667 |             4.02178 |                    1 |                   nan |                    nan |             4.00076 |             0.666667 |
| 49bbcb51af2bd2d0bf460fd2a290a93b314bb7c4 |              2 |            9 |           1 |   0        |    0        |           nan       |                  nan |                   nan |                    nan |             2.50175 |             0.666667 |
| dd63cb8c84681efcc95042812a6e49a7a0bc9646 |              2 |            8 |           1 |   7.69231  |    1        |             7.69231 |                    1 |                   nan |                    nan |             7.3046  |             0.8      |


### 透過標的物相連

請見num_byTag，此欄表示透過標的物相連的客戶數

- 關聯顧客數由高到低top 10

| index                                    |   plyAmt |   clmAmt |   ipolicy |   clmed_iply |   num_original |   num_byAppl |   num_byTag |   clm_rate |   clm_ratio |   plyAmt_直接連接 |   clmAmt_直接連接 |   ipolicy_直接連接 |   clmed_iply_直接連接 |   clm_rate_直接連接 |   clm_ratio_直接連接 |   plyAmt_通過標的物 |   clmAmt_通過標的物 |   ipolicy_通過標的物 |   clmed_iply_通過標的物 |   clm_rate_通過標的物 |   clm_ratio_通過標的物 |   plyAmt_通過要保 |   clmAmt_通過要保 |   ipolicy_通過要保 |   clmed_iply_通過要保 |   clm_rate_通過要保 |   clm_ratio_通過要保 |
|:-----------------------------------------|---------:|---------:|----------:|-------------:|---------------:|-------------:|------------:|-----------:|------------:|------------------:|------------------:|-------------------:|----------------------:|--------------------:|---------------------:|--------------------:|--------------------:|---------------------:|------------------------:|----------------------:|-----------------------:|------------------:|------------------:|-------------------:|----------------------:|--------------------:|---------------------:|
| e5b96592ae8e9bc0a179d2644e24fdb4353fcc40 |   296235 |        0 |        40 |            0 |              1 |            1 |          19 |     0      |    0        |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |    996479           |    394419           |                  627 |                      19 |              0.395813 |              0.030303  |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |
| 1cf4905d6b42b4bc359d0a37ef0f633d0fea54c9 |     5880 |        0 |         6 |            0 |              1 |            1 |          17 |     0      |    0        |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |    481981           |    782952           |                  143 |                      12 |              1.62445  |              0.0839161 |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |
| d69004d76503004aaf1a3d192f2e4fce323725c8 |    42862 |        0 |         6 |            0 |              2 |            2 |          14 |     0      |    0        |            641470 |                 0 |                 95 |                     0 |             0       |             0        |    734198           |    179300           |                  340 |                       9 |              0.244212 |              0.0264706 |            641470 |                 0 |                 95 |                     0 |             0       |             0        |
| 594761876024a6a16ec41401ecc8fc56f1f4e86d |   116520 |        0 |        40 |            0 |              1 |            1 |          13 |     0      |    0        |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |         0           |         0           |                    0 |                       0 |            nan        |            nan         |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |
| 6ceba27eb5cd4253fa077f2ad075a9002d2c7e73 |    83480 |        0 |        60 |            0 |              3 |            3 |          13 |     0      |    0        |             47868 |                 0 |                 20 |                     0 |             0       |             0        |    423720           |         1.76942e+06 |                   79 |                       8 |              4.17591  |              0.101266  |             47868 |                 0 |                 20 |                     0 |             0       |             0        |
| b244ff331370d045c1ae27696bc3954c71d0f5d7 |   133240 |        0 |        50 |            0 |              4 |            4 |          13 |     0      |    0        |            337855 |            544095 |                 35 |                    10 |             1.61044 |             0.285714 |         1.13612e+06 |    222493           |                  214 |                      13 |              0.195835 |              0.0607477 |            337855 |            544095 |                 35 |                    10 |             1.61044 |             0.285714 |
| 73614988b08f8c327caa7c289a7f0cd748ba2c03 |   222740 |        0 |        40 |            0 |              1 |            1 |          12 |     0      |    0        |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |    257683           |     73880           |                   70 |                       2 |              0.286709 |              0.0285714 |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |
| d29f63cf6b16de210c02608180c94f620f4e9ad3 |   126714 |        0 |        15 |            0 |              1 |            1 |          12 |     0      |    0        |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |    227476           |     28400           |                   36 |                       2 |              0.124848 |              0.0555556 |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |
| 740657d5b2b2d2af2ea279bef3ac990c96ac13bf |    80645 |   118500 |        35 |            5 |              1 |            1 |          11 |     1.4694 |    0.142857 |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |    452584           |         0           |                   94 |                       0 |              0        |              0         |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |
| 310d5a8dac35d451e9fbf7c0ae467352ad970361 |     6226 |        0 |         2 |            0 |              1 |            1 |          11 |     0      |    0        |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |     53710           |         0           |                   33 |                       0 |              0        |              0         |                 0 |                 0 |                  0 |                     0 |           nan       |           nan        |


- 高風險族群: clm_ipolicy_通過標的物 > .5 & clm_rate_通過標的物 > 1

| index                                    |   num_original |   num_byAppl |   num_byTag |   clm_rate |   clm_ratio |   clm_rate_直接連接 |   clm_ratio_直接連接 |   clm_rate_通過標的物 |   clm_ratio_通過標的物 |   clm_rate_通過要保 |   clm_ratio_通過要保 |
|:-----------------------------------------|---------------:|-------------:|------------:|-----------:|------------:|--------------------:|---------------------:|----------------------:|-----------------------:|--------------------:|---------------------:|
| 09495a6939fe0d3b17f06c56c0bfe5a5edfd4df2 |              1 |            1 |           4 |   0.991786 |    0.125    |                 nan |                  nan |              14.6801  |               1        |                 nan |                  nan |
| 3776007f7138bfef578348d52f7237a1d81a8062 |              1 |            1 |           4 |   0        |    0        |                 nan |                  nan |               3.51753 |               0.6      |                 nan |                  nan |
| fa7a064ecbad42de47122ad7c5079740967e40e0 |              1 |            1 |           4 |   0        |    0        |                 nan |                  nan |              26.4783  |               0.565217 |                 nan |                  nan |
| 5af60e317a3886b24660529bccfd0597ac0f0ea2 |              1 |            1 |           3 |   6.387    |    0.333333 |                 nan |                  nan |               6.86006 |               0.571429 |                 nan |                  nan |
| c3fb786b9d6f49f788d3aafab2cb5219c32beb2d |              1 |            1 |           3 |   3.60116  |    0.125    |                 nan |                  nan |               2.66555 |               0.789474 |                 nan |                  nan |
| d96cdca1dc4230c31fe7c27339320db4cbde4362 |              1 |            1 |           3 |   0.935206 |    0.125    |                 nan |                  nan |               9.18257 |               0.509804 |                 nan |                  nan |
| c0bdc83e3a07f8a628744ab959b4b9366994d78b |              1 |            1 |           3 |   0.526847 |    0.125    |                 nan |                  nan |               2.56653 |               1        |                 nan |                  nan |
| c7dc6425466507540139541e7fe870e6657dae9f |              1 |            1 |           3 |   0.518928 |    0.125    |                 nan |                  nan |              21.425   |               0.6      |                 nan |                  nan |
| 6f05862a8ce45516fc17c86d5c3a5ba580c09607 |              1 |            1 |           3 |   0.387915 |    0.125    |                 nan |                  nan |              22.2115  |               0.666667 |                 nan |                  nan |
| 0c42b20d1d0bf4677463e7bc8944775f004484be |              1 |            1 |           3 |   0.295087 |    0.166667 |                 nan |                  nan |               3.13268 |               0.571429 |                 nan |                  nan |